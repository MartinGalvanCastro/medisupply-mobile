---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: react-native

trigger_map:
  - pull_request_target_branch: main
    workflow: e2e_android
  - push_branch: main
    workflow: build_debug_artifacts

workflows:
  e2e_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: standard
    steps:
      - git-clone@8: {}
      - nvm@1:
          title: Set Node.js version
          inputs:
            - node_version: "22.18.0"
      - restore-cache@2:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - key: npm-cache-
      - yarn@0:
          title: Install dependencies
          inputs:
            - command: install
            - cache_local_deps: 'yes'
      - script@1:
          title: Build Android app for Detox
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                export EXPO_PUBLIC_API_URL=http://localhost:8000
                export GRADLE_OPTS="-Xmx6144m -XX:MaxMetaspaceSize=1536m"
                cd android && ./gradlew assembleRelease assembleAndroidTest -DtestBuildType=release -Dorg.gradle.jvmargs="-Xmx6144m -XX:MaxMetaspaceSize=1536m" --no-daemon --stacktrace --max-workers=2
      - script@1:
          title: Start mock server
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                yarn e2e:mock-server &
                sleep 5
                curl http://localhost:8000/ || echo "Mock server health check failed"
      - script@1:
          title: Run E2E tests
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                yarn e2e:test:android:release
      - deploy-to-bitrise-io@2:
          inputs:
            - deploy_path: $BITRISE_SOURCE_DIR/artifacts
            - is_compress: 'true'
      - save-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - paths: |
                $BITRISE_SOURCE_DIR/node_modules
                $BITRISE_SOURCE_DIR/android/.gradle

  build_debug_artifacts:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: standard
    steps:
      - git-clone@8: {}
      - nvm@1:
          title: Set Node.js version
          inputs:
            - node_version: "22.18.0"
      - restore-cache@2:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - key: npm-cache-
      - yarn@0:
          title: Install dependencies
          inputs:
            - command: install
            - cache_local_deps: 'yes'
      - gradle-runner@4:
          title: Build Android Debug APK
          inputs:
            - gradle_task: assembleDebug
            - gradlew_path: $BITRISE_SOURCE_DIR/android/gradlew
            - gradle_options: -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m" --no-daemon --stacktrace
            - app_file_exclude_filter: "*unaligned.apk\n*Test*.apk"
      - deploy-to-bitrise-io@2:
          title: Deploy Android artifacts
          inputs:
            - is_compress: 'false'
            - notify_user_groups: none
            - is_enable_public_page: 'true'
      - save-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - paths: |
                $BITRISE_SOURCE_DIR/node_modules
                $BITRISE_SOURCE_DIR/android/.gradle
