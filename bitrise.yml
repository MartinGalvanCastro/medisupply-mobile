---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: react-native

trigger_map:
  - pull_request_target_branch: main
    workflow: e2e_android
  - push_branch: main
    workflow: build_debug_artifacts

workflows:
  e2e_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: standard
    steps:
      - git-clone@8: {}
      - nvm@1:
          title: Set Node.js version
          inputs:
            - node_version: "22.18.0"
      - restore-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - key: npm-cache-
      - yarn@0:
          title: Install dependencies
          inputs:
            - command: install
            - cache_local_deps: 'yes'
      - script@1:
          title: Run Expo prebuild for Android
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                npx expo prebuild --platform android --clean
      - script@1:
          title: Set Gradle JVM options
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                envman add --key GRADLE_OPTS --value "-Xmx2048m -XX:MaxMetaspaceSize=512m"
      - script@1:
          title: Build Android app for Detox
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                export EXPO_PUBLIC_API_URL=http://localhost:8000
                yarn e2e:build:android:release
      - script@1:
          title: Start mock server
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                yarn e2e:mock-server &
                sleep 5
                curl http://localhost:8000/ || echo "Mock server health check failed"
      - script@1:
          title: Run E2E tests
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                yarn e2e:test:android:release
      - deploy-to-bitrise-io@2:
          inputs:
            - deploy_path: $BITRISE_SOURCE_DIR/artifacts
            - is_compress: 'true'
      - save-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - paths: |
                $BITRISE_SOURCE_DIR/node_modules
                $BITRISE_SOURCE_DIR/android/.gradle

  e2e_ios:
    meta:
      bitrise.io:
        stack: osx-xcode-16.2.x
        machine_type_id: g2-m1.4core
    steps:
      - git-clone@8: {}
      - nvm@1:
          title: Set Node.js version
          inputs:
            - node_version: "22.18.0"
      - restore-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - key: npm-cache-
      - yarn@0:
          title: Install dependencies
          inputs:
            - command: install
            - cache_local_deps: 'yes'
      - script@1:
          title: Install applesimutils
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                brew tap wix/brew
                brew install applesimutils
      - script@1:
          title: Run Expo prebuild for iOS
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                npx expo prebuild --platform ios --clean
      - script@1:
          title: Install CocoaPods
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                cd ios && pod install && cd ..
      - script@1:
          title: Build iOS app for Detox
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                export EXPO_PUBLIC_API_URL=http://localhost:8000
                yarn e2e:build:ios:release
      - script@1:
          title: Start mock server
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                yarn e2e:mock-server &
                sleep 5
                curl http://localhost:8000/ || echo "Mock server health check failed"
      - script@1:
          title: Run E2E tests
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                yarn e2e:test:ios:release
      - deploy-to-bitrise-io@2:
          inputs:
            - deploy_path: $BITRISE_SOURCE_DIR/artifacts
            - is_compress: 'true'
      - save-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - paths: |
                $BITRISE_SOURCE_DIR/node_modules
                $BITRISE_SOURCE_DIR/ios/Pods

  unit_tests:
    meta:
      bitrise.io:
        stack: osx-xcode-16.2.x
        machine_type_id: g2-m1.4core
    steps:
      - git-clone@8: {}
      - nvm@1:
          title: Set Node.js version
          inputs:
            - node_version: "22.18.0"
      - restore-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - key: npm-cache-
      - yarn@0:
          title: Install dependencies
          inputs:
            - command: install
      - yarn@0:
          title: Run unit tests
          inputs:
            - command: test:coverage
      - save-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - paths: $BITRISE_SOURCE_DIR/node_modules

  build_debug_artifacts:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: standard
    steps:
      - git-clone@8: {}
      - nvm@1:
          title: Set Node.js version
          inputs:
            - node_version: "22.18.0"
      - restore-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - key: npm-cache-
      - yarn@0:
          title: Install dependencies
          inputs:
            - command: install
            - cache_local_deps: 'yes'
      - script@1:
          title: Run Expo prebuild for Android
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                npx expo prebuild --platform android --clean
      - script@1:
          title: Set Gradle JVM options
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -ex
                envman add --key GRADLE_OPTS --value "-Xmx2048m -XX:MaxMetaspaceSize=512m"
      - gradle-runner@2:
          title: Build Android Debug APK
          inputs:
            - gradle_file: $BITRISE_SOURCE_DIR/android/build.gradle
            - gradle_task: assembleDebug
            - gradlew_path: $BITRISE_SOURCE_DIR/android/gradlew
      - deploy-to-bitrise-io@2:
          title: Deploy Android artifacts
          inputs:
            - deploy_path: $BITRISE_SOURCE_DIR/android/app/build/outputs/apk/debug/*.apk
            - is_compress: 'false'
            - notify_user_groups: none
            - is_enable_public_page: 'true'
      - save-cache@1:
          inputs:
            - key: npm-cache-{{ checksum "yarn.lock" }}
            - paths: |
                $BITRISE_SOURCE_DIR/node_modules
                $BITRISE_SOURCE_DIR/android/.gradle
